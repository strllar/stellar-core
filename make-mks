#!/bin/sh -e

case "$0" in
    */*)
	cd $(dirname $0)
	;;
esac

# Bail if not under git
git rev-parse

trap 'rm -f src/src.mk lib/medida.mk lib/lib.mk' 0

message="# This file was generated by make-mks; don't edit it by hand."

# Use only files git knows about, to avoid picking up autogenrated
# files or other random cruft.  When adding a new file foo.cpp, you
# must run "git add -N foo.cpp" before running this script.
(cd src
 echo "$message"
 echo "SRC_H_FILES" = $(git ls-files '*.h' '*.[ih]pp')
 echo "SRC_CXX_FILES" = $(git ls-files '*.cpp')
 echo "SRC_X_FILES" = $(git ls-files '*.x')
) > src/src.mk


# Hacks for shell third-party libraries without autoconf.  You may
# need to re-run this after updating submodules.

(if test -f lib/libmedida/src/medida/medida.h; then
     echo "$message"
     echo INTERNAL_MEDIDA_FILES = lib/libmedida/src/medida/*{,/*}.{cc,h}
 fi) > lib/medida.mk

(echo "$message"
 echo SOCI_FILES = lib/soci/src/{backends/sqlite3,core}/*.{h,cpp}
 echo SOCI_PG_FILES = lib/soci/src/backends/postgresql/*.{h,cpp}

 echo SQLITE3_FILES = lib/sqlite/*.[ch]
 echo UTIL_FILES = lib/*.hpp lib/util/*.{h,hpp,c,cc,cpp} lib/http/*.{h,hpp,cpp}
 echo ASIO_H_FILES = $(find lib/asio/include -name '*.[chi]pp')
 echo ASIO_CXX_FILES = lib/asio/src/*.cpp
 echo JSON_FILES = lib/json/*.{h,cpp}

 echo MISC_H_FILES = lib/*.hpp \
      $(find lib/{autocheck,cereal} \
		     \( -name '*.h' -o -name '*.hpp' \) -print)
) > lib/lib.mk

trap '' 0
